<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>International trade relationship explorer</title>
<link rel="stylesheet"
	href="https://bootswatch.com/cosmo/bootstrap.min.css">
</head>

<style>
#graph {
	display: relative;
	width: 100%;
	height: 75%;
}
</style>

<body>
	<div class="container">
		<div class="row">
			<div class="col-sm-6 col-md-6">

				<div data-role="content">
					<div class="form-group">
						<input type="text" value="SIM FREE LTD"
							placeholder="Search for Company Name" class="form-control"
							id="company_str">
					</div>
					<button id="search" class="btn btn-default btn-xs">Search</button>
					<button id="split" class="btn btn-default btn-xs">Split</button>
					<button id="unite" class="btn btn-default btn-xs">Unite</button>
				</div>


			</div>
			<div class="col-sm-6 col-md-6">

				<div data-role="content">
					<div class="form-group">
						<input type="text" value="2"
							placeholder="How many common goods" class="form-control"
							id="num_nodes">
					</div>
				</div>
				<div data-role="content">
					<div class="form-group">
						<input type="text" value="100"
							placeholder="Limit number of nodes to display" class="form-control"
							id="node_limit">
					</div>
				</div>
			</div>
		</div>
	</div>




	<script type="text/javascript"
		src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="http://d3js.org/d3.v3.min.js" type="text/javascript"></script>
	<script type="text/javascript">
   
	
	

</script>

 	  

<div id="container"></div>

 
<script src="https://d3js.org/d3.v4.min.js"></script>

<script>

var width = 800, height = 600;
var canvas = d3.select('#container').append('canvas').attr('width', width).attr('height', height);


$("#search").click( function()
	       {
		  var query=$("#company_str").val();
		  var query2=$("#num_nodes").val();
		  var query3=$("#node_limit").val();
		  
		d3.json("/graph?q=" + encodeURIComponent(query) + "&n=" +
   			  	encodeURIComponent(query2) + "&lim=" +
   			  	encodeURIComponent(query3), function(error, json) {
		  if (error) throw error;
		       		  
		  	graph = json;
		  
			nodes = graph.nodes;
	   		links = graph.links;
		
	   		   		
	   		draw();
		});
	       }
);	


  
d3.select('button#split').on('mousedown', function(d) {

	simulation.stop();

	simulation
		.force('charge', d3.forceManyBody().strength(
				function(d) { 
				
					return d.type === "company" ? -100 : 0; 
					
				} 		
		
		))
		 .force("link", d3.forceLink(links).distance(40).strength(1))
		.force('xPos', d3.forceX(function(d) { 
			
			return d.direction === "Imported" ? width * -0.5 : width * 0.5; 
			
		}) )
		.force('yPos', d3.forceY(function(d) { 
			
			return d.type === "hscode" ? 0 : height * -0.8; 
			
		}));
		
	simulation.alpha(0.5);

	simulation.restart();

}); // button listener/handler

d3.select('button#unite').on('mousedown', function(d) {

	simulation.stop();

	simulation
	 .force("charge", d3.forceManyBody().strength(-30))
	    .force("link", d3.forceLink(links).distance(40).strength(1))
	    .force("x", d3.forceX())
	    .force("y", d3.forceY());
		
	simulation.alpha(0.5);

	simulation.restart();

}); // button listener/handler




 // Toggle children on click.
    function click() {
	 
    
	const a = this.parentNode;
    const m = d3.mouse(this);
    
    console.log("x=" + m[0] +"y=" + m[1]);
    
    console.log("x=" + trans.invertX(m[0]) +"y=" + trans.invertY(m[1]));

    
    	    const d = simulation.find(
    	      trans.invertX(m[0] - width / 2),
    	      trans.invertY(m[1] - height / 2),
    	      10);
    	 
    	
     console.dir(d);
	 
     
        context.clearRect(0, 0, canvas.width, canvas.height);
             
        var query2=$("#num_nodes").val();
        var query3=$("#node_limit").val();
			
   		d3.json("/graph?q=" + encodeURIComponent(d.name) + "&n=" +
   			  	encodeURIComponent(query2) + "&lim=" +
   			  	encodeURIComponent(query3), function(error, json) {
   			
   		
   			
   			if (error) throw error;
   			  graph = json;
   			  
   			  nodes = graph.nodes;
   			  links = graph.links;
   			  
   			  draw();
   		
   		});
    	
	}
    

    

var nodes, 
	links,
	context,
	canvas, 
	simulation;

var trans = d3.zoomIdentity; //<-- identity





function draw() {

	 simulation = d3.forceSimulation(nodes)
	 
	 //.alpha(.02)
	    .force("charge", d3.forceManyBody().strength(-30))
	    .force("link", d3.forceLink(links).distance(40).strength(1))
	    .force("x", d3.forceX())
	    .force("y", d3.forceY())
	    .on("tick", ticked);
	
	 canvas = document.querySelector("canvas"),
	    context = canvas.getContext("2d"),
	//    width = canvas.width,
	//    height = canvas.height;
	  	
	
	d3.select(canvas)
	    .call(d3.drag()
	        .container(canvas)
	        .subject(dragsubject)
	       // .on("mouseover",tooltip)
	        .on("start", dragstarted)
	        .on("drag", dragged)
	        .on("end", dragended));
	       
    function zoomed(d) {
		  trans = d3.event.transform; //<-- set to current transform
		  ticked(); //<-- use tick to redraw regardless of event
		}
	    
	  //now the zooming part
	   d3.select(canvas).call(d3.zoom().scaleExtent([0.2, 10]).on("zoom", zoomed))

	
	
	
	d3.select(canvas).on('click', click);
	
	


	
	function ticked() {
	
				
		
	 	context.clearRect(0, 0, width, height);
	  	context.save();
	  	//context.translate(width / 2, height / 2);
	  	
	  	context.translate(trans.x + width/2, trans.y + height/2); //<-- this always applies a transform
	  	context.scale(trans.k, trans.k);
	
	 	context.beginPath();
	  	links.forEach(drawLink);
  		context.strokeStyle = "#CCC";
  		context.lineWidth=0.5;
	 	context.stroke();
	
	 
	  	nodes.forEach(drawNode);
	  	
	 	
	  
  		
	  	context.restore();
	  	
		nodes[0].x = 0;
		nodes[0].y = height/4;

	}
	
}

function dragsubject() {
  return simulation.find(trans.invertX(d3.event.x - width / 2), trans.invertY(d3.event.y - height / 2), 10);
}

function dragstarted() {
  if (!d3.event.active) simulation.alphaTarget(0.3).restart();
  d3.event.subject.fx = d3.event.subject.x;
  d3.event.subject.fy = d3.event.subject.y;
}

function dragged() {
 d3.event.subject.fx = d3.event.x;
  d3.event.subject.fy = d3.event.y;
}

function dragended() {
  if (!d3.event.active) simulation.alphaTarget(0);
  //d3.event.subject.fx = null;  Commenting out makes sticky
  //d3.event.subject.fy = null;
}

function drawLink(d) {
  context.moveTo(d.source.x, d.source.y);
  context.lineTo(d.target.x, d.target.y);
}

function drawNode(d) {
	
	context.font="8px Arial";
	// Companies circles
 		
	if (d.type == "company")	{
		context.beginPath();	
	  	context.moveTo(d.x + Math.pow(d.size), d.y);
	  	context.arc(d.x, d.y, 2* Math.pow(d.size,0.25) , 0, 2 * Math.PI);
		
		if (d.direction == "Imported") context.fillStyle = "yellow";
		else if (d.direction == "Exported") context.fillStyle = "green";
		else context.fillStyle = "purple";
		
		context.fill();
		
		context.fillStyle = "black";
		context.fillText(d.name,d.x,d.y);

		
	}		
		
	if (d.type == "hscode")	{
		
		context.beginPath();	
	  	context.moveTo(d.x + Math.pow(d.size), d.y);
	  	context.arc(d.x, d.y, 0.5 * Math.pow(d.size,0.25) , 0, 2 * Math.PI);
	  	
		if (d.direction == "Imported") context.fillStyle = "red";
		else if (d.direction == "Exported") context.fillStyle = "blue";

		context.fill();
	}
			
	context.strokeStyle = "#CCC";
  	context.stroke();
  	

  	
}

</script>

<!--

<style type="text/css">

.node {
	stroke: #222;
	stroke-width: 1.5px;

}

.node.focal.company {
	fill: purple;

	
}

.node.Imported.company {
	fill: yellow
	
}

.node.Exported.company {
	fill: green
	
}

.node.Imported.hscode {
	fill: red;
}

.node.Exported.hscode {
	fill: blue
}

.label {

font-size:9px;
font-weight: 400;

}



.node.text {
  pointer-events: none;
  font: 10px;
}


.link {
	stroke: #999;
	stroke-opacity: .6;
	stroke-width: 1px;
}
</style>

	<!--  BELOW IS THE SVG IMPLEMENTATION  
	<div id="graph"></div>
	<script type="text/javascript">

	
	var width = 800, height = 600;
   
	var margin = {top: -5, right: -5, bottom: -5, left: -5};
    var width = 800 - margin.left - margin.right,
		height = 600- margin.top - margin.bottom;	
	
    var force = d3.layout.force()
            		.charge(-100)
            		.linkDistance(70)
            		.size([width, height]);
   
    
    var svg = d3.select("#graph").append("svg")
            .attr("width", "100%").attr("height", "100%")
            .attr("pointer-events", "all");
    
   

    var drag = force.drag()
        .on("dragstart", dragstart) ;
   	    
    function dblclick(d) {
  	  d3.select(this).classed("fixed", d.fixed = false);
  	}
    
    function size(d) {
    	return 5* Math.pow(d.size,0.15); // Inline if depending on commodity or company
    }

  	function dragstart(d) {
  		d3.select(this).classed("fixed", d.fixed = true);
  	}

  	
  	
    
   	var graph;
  	
   	var link = svg.selectAll(".link");
	var node = svg.selectAll(".node");
	   
  	  
//	d3.json("/graph", function(error, json) {
//		  if (error) throw error;

//		  graph = json;
//		  update(graph);
//	});
    
	
	  $("#search").click( function()
		       {
			  var query=$("#company_str").val();
			  var query2=$("#num_nodes").val();
			  	
			  graph = null;
		     	link = svg.selectAll(".link");
		    	node = svg.selectAll(".node"); 
		    	
		   //  	d3.selectAll("svg > *").remove();
		   
		   d3.select("svg").remove();
		   
		   svg = d3.select("#graph").append("svg")
           .attr("width", "100%").attr("height", "100%")
           .attr("pointer-events", "all");
   
		   link = svg.selectAll(".link");
	    	node = svg.selectAll(".node"); 
	    	
		   
			  
			  d3.json("/graph?q=" + encodeURIComponent(query) + "&n=" +
			  	encodeURIComponent(query2), function(error, json) {
	      		  if (error) throw error;
	      		       		  
	      		  graph = json;
	      		  update(graph);
	      		});
		       }
		  );	
	
	
	// Toggle children on click.
    function click(d) {
    	var query2=$("#num_nodes").val();
      	
    	 if (d3.event.defaultPrevented) return; // dragged
     console.dir(d);
	 
    	//graph = null;
     ///	link = svg.selectAll(".link");
    	//node = svg.selectAll(".node"); 
    	
     //	d3.selectAll("svg > *").remove();
     
       d3.select("svg").remove();
		   
		   svg = d3.select("#graph").append("svg")
           .attr("width", "100%").attr("height", "100%")
           .attr("pointer-events", "all");
   
		   link = svg.selectAll(".link");
	    	node = svg.selectAll(".node"); 
     
     
   		d3.json("/graph?q=" + encodeURIComponent(d.name) + "&n=" +
			  	encodeURIComponent(query2), function(error, json) {
   			
   			if (error) throw error;
   			  graph = json;
   			  update(graph);
   		
   		});
    	
	}
		
	function update(graph) {
  
    console.log(graph);
 	force
	   .nodes(graph.nodes)
	   .links(graph.links)
	   .start();
 	


    link = link.data(graph.links).enter()
			.append("line").attr("class", "link");	
	
        
    node = node.data(graph.nodes).enter()
		    .append("circle")
		    .attr("class", function (d) { return "node "+ d.direction + " " + d.type })
		    //attr("class", function (d) { return  d.direction })
		    .attr("r", size)
		    .on("click",click)
		    .on("dblclick",dblclick)
		    .call(drag);
    
    // text label not working
   // node.append("text")
         //	.text(function(d) { return d.name });
    
        // html title attribute
        node.append("title")
                .text(function (d) { return d.name; })
       	
       var texts = svg.selectAll("text.label")
                .data(graph.nodes)
                .enter().append("text")
                .attr("class", "label")
                .attr("fill", "black")
                .text(function(d) {  return d.name;  });
                

                
        // force feed algo ticks
        force.on("tick", function() {
          
     	
        	
        	link.attr("x1", function(d) { return d.source.x; })
                    .attr("y1", function(d) { return d.source.y; })
                    .attr("x2", function(d) { return d.target.x; })
                    .attr("y2", function(d) { return d.target.y; });
           
            
            node.attr("cx", function(d) { return d.x; })
                    .attr("cy", function(d) { return d.y; });
            
            texts.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")" });
            
           // node[0].x = width / 2;
     	   // node[0].y = height / 2;
            
        });

    	
    }
    
       
     

</script>

-->
	<div class="container">
		<div class="row">
			<div class="col-sm-4 col-md-4">
				<div data-role="content">
					<div class="form-group">
						<input type="text" value="84717050"
							placeholder="Enter commodity code" class="form-control"
							id="code_to_check">
						<button id="desc_lookup" class="btn btn-default">Lookup</button>
					</div>
				</div>
			</div>
			<div class="col-sm-8 col-md-8">
					<!-- <input type="text" value="" height=2
							placeholder="Resulting description" class="form-control"
							id="goods_descriptions"> -->
				<span id="goods_descriptions">
					
				</span>
				
			</div>
		</div>
		<div class="row">
		</div>
	</div>

	<script type="text/javascript">
		$("#desc_lookup").click(function(){
			var searchstring = "/descriptions?cn1=" + $("#code_to_check").val();
			console.log(searchstring);
			$.get(searchstring, function(data, status){$("#goods_descriptions").text(data)});
		});
		
	</script>



</body>
</html>